<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <title>Generate Report — FleetPulse</title>
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; }
    #sidebar-mount { display: contents; }
    .fade-up {
      opacity: 0;
      transform: translateY(16px);
      animation: fadeUp 0.5s ease forwards;
    }
    @keyframes fadeUp {
      to { opacity: 1; transform: translateY(0); }
    }
    .row-in {
      animation: rowSlide 0.3s ease both;
    }
    @keyframes rowSlide {
      from { opacity: 0; transform: translateX(-10px); }
      to   { opacity: 1; transform: translateX(0); }
    }
    select { background-image: none; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 99px; }
    #confirm-overlay { backdrop-filter: blur(4px); }
    @media print {
      .no-print { display: none !important; }
      #sidebar-mount, header { display: none !important; }
      main { margin-left: 0 !important; padding-top: 0 !important; }
      .print-card { box-shadow: none !important; border: 1px solid #e2e8f0 !important; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <!-- SIDEBAR -->
  <div id="sidebar-mount"></div>

  <!-- TOP NAV -->
  <header class="no-print fixed top-0 right-0 left-0 sm:left-64 z-30 h-16 bg-white border-b border-slate-100 flex items-center justify-between px-6 shadow-sm">
    <button id="sidebar-toggle" class="sm:hidden p-2 rounded-lg hover:bg-slate-100 text-slate-500 transition-colors">
      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </button>

    <div class="flex items-center gap-2 text-sm">
      <span class="text-slate-400">Fleet Manager</span>
      <span class="text-slate-300">/</span>
      <span class="font-semibold text-slate-700">Generate Report</span>
    </div>

    <div class="flex items-center gap-3">
      <button class="relative p-2 rounded-lg hover:bg-slate-100 text-slate-400 transition-colors">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
        </svg>
        <span class="absolute top-1.5 right-1.5 w-2 h-2 bg-blue-500 rounded-full"></span>
      </button>
      <button id="signout-btn"
        class="flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-red-500 bg-slate-100 hover:bg-red-50 px-4 py-2 rounded-lg transition-all">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
        </svg>
        Sign out
      </button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="sm:ml-64 pt-16 min-h-screen">
    <div class="p-6 md:p-8 max-w-6xl mx-auto">

      <!-- Page header -->
      <div class="mb-8 fade-up" style="animation-delay:.05s">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center shadow-md shadow-emerald-500/25">
              <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"/>
              </svg>
            </div>
            <div>
              <h1 class="text-xl font-bold text-slate-800">Service Report</h1>
              <p class="text-sm text-slate-400">Scheduled maintenance overview for all bikes</p>
            </div>
          </div>
          <!-- Action buttons -->
          <div class="flex items-center gap-3 no-print">
            <button id="print-btn"
              class="flex items-center gap-2 text-sm font-medium text-slate-600 bg-white border border-slate-200 hover:border-slate-300 hover:bg-slate-50 px-4 py-2 rounded-xl transition-all shadow-sm">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
              </svg>
              Print
            </button>
            <button id="export-btn"
              class="flex items-center gap-2 text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-xl transition-all shadow-md shadow-emerald-500/25">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
              Export CSV
            </button>
          </div>
        </div>
      </div>

      <!-- STATS ROW -->
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6 fade-up" style="animation-delay:.08s">
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm px-5 py-4">
          <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-1">Total Bikes</p>
          <p class="text-2xl font-bold text-slate-800" id="stat-total">0</p>
        </div>
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm px-5 py-4">
          <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-1">Due Soon</p>
          <p class="text-2xl font-bold text-amber-500" id="stat-due">0</p>
        </div>
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm px-5 py-4">
          <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-1">Overdue</p>
          <p class="text-2xl font-bold text-red-500" id="stat-overdue">0</p>
        </div>
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm px-5 py-4">
          <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-1">Up to Date</p>
          <p class="text-2xl font-bold text-emerald-600" id="stat-ok">0</p>
        </div>
      </div>

      <!-- TABLE CARD -->
      <div class="bg-white rounded-2xl border border-slate-100 shadow-sm print-card fade-up" style="animation-delay:.12s">

        <!-- Table toolbar -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-slate-100 flex-wrap gap-3 no-print">
          <div>
            <h2 class="font-bold text-slate-800">Maintenance Records</h2>
            <p class="text-xs text-slate-400 mt-0.5"><span id="record-count">0</span> bikes on record</p>
          </div>
          <div class="flex items-center gap-3">
            <!-- Status filter -->
            <div class="relative">
              <select id="status-filter"
                class="appearance-none text-sm bg-slate-50 border border-slate-200 rounded-xl pl-3 pr-8 py-2 text-slate-600 outline-none focus:border-emerald-400 cursor-pointer">
                <option value="all">All Statuses</option>
                <option value="ok">Up to Date</option>
                <option value="due">Due Soon</option>
                <option value="overdue">Overdue</option>
              </select>
              <span class="absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs">▾</span>
            </div>
            <!-- Search -->
            <div class="relative">
              <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <input type="text" id="search-input" placeholder="Search bikes or riders…"
                class="pl-9 pr-4 py-2 text-sm bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-100 w-52 transition-all"/>
            </div>
          </div>
        </div>

        <!-- Print header (only visible when printing) -->
        <div class="hidden print:block px-8 pt-6 pb-2">
          <div class="flex items-center justify-between border-b border-slate-200 pb-4 mb-2">
            <div>
              <h1 class="text-2xl font-bold text-slate-800">FleetPulse</h1>
              <p class="text-sm text-slate-500">Service Report</p>
            </div>
            <p class="text-sm text-slate-400">Generated: <span id="print-date"></span></p>
          </div>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-slate-50 border-b border-slate-100">
                <th class="text-left text-xs font-semibold text-slate-400 uppercase tracking-wider px-6 py-3">#</th>
                <th class="text-left text-xs font-semibold text-slate-400 uppercase tracking-wider px-6 py-3">Bike Plates</th>
                <th class="text-left text-xs font-semibold text-slate-400 uppercase tracking-wider px-6 py-3">Rider</th>
                <th class="text-left text-xs font-semibold text-slate-400 uppercase tracking-wider px-6 py-3">Previous Service</th>
                <th class="text-left text-xs font-semibold text-slate-400 uppercase tracking-wider px-6 py-3">Next Service</th>
                <th class="text-left text-xs font-semibold text-slate-400 uppercase tracking-wider px-6 py-3 no-print">Status</th>
              </tr>
            </thead>
            <tbody id="reportBody" class="divide-y divide-slate-50"></tbody>
          </table>

          <!-- Empty state -->
          <div id="empty-state" class="flex flex-col items-center justify-center py-16 text-slate-300">
            <svg class="w-12 h-12 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"/>
            </svg>
            <p class="text-sm font-medium text-slate-400">No service records found</p>
            <p class="text-xs text-slate-300 mt-1">Records will appear here once maintenance is logged</p>
            <a href="maintainance.html"
              class="mt-4 text-xs font-semibold text-emerald-600 hover:text-emerald-700 bg-emerald-50 hover:bg-emerald-100 px-4 py-2 rounded-xl transition-all">
              Go to Maintenance →
            </a>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- SIGN-OUT MODAL -->
  <div id="confirm-overlay" class="hidden fixed inset-0 z-50 bg-slate-900/40 flex items-center justify-center">
    <div id="confirm-modal" class="bg-white rounded-2xl shadow-2xl p-7 w-80 text-center transform transition-all scale-95 opacity-0">
      <div class="w-12 h-12 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-6 h-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
        </svg>
      </div>
      <h3 class="font-bold text-slate-800 mb-1">Sign out?</h3>
      <p class="text-sm text-slate-400 mb-6">You'll be redirected to the login page.</p>
      <div class="flex gap-3">
        <button id="noBtn" class="flex-1 py-2.5 rounded-xl border border-slate-200 text-slate-600 text-sm font-medium hover:bg-slate-50 transition-colors">Cancel</button>
        <a href="login.html" class="flex-1 py-2.5 rounded-xl bg-red-500 text-white text-sm font-semibold hover:bg-red-600 transition-colors text-center">Sign out</a>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed bottom-6 right-6 z-50 flex items-center gap-3 bg-slate-800 text-white text-sm font-medium px-5 py-3 rounded-xl shadow-xl translate-y-16 opacity-0 transition-all duration-300">
    <svg class="w-4 h-4 text-green-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
    </svg>
    <span id="toast-msg">Done!</span>
  </div>

  <script>
    // ── SIDEBAR IMPORT ──────────────────────────────────────────
    fetch('sidebar.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('sidebar-mount').innerHTML = html;
        setTimeout(() => {
          document.querySelectorAll('.sidebar-link').forEach(a => {
            a.classList.remove('bg-blue-600','text-white','shadow-md','shadow-blue-600/30','font-semibold');
            a.classList.add('text-slate-300');
          });
          const link = document.querySelector('a[href="report.html"]');
          if (link) {
            link.classList.remove('text-slate-300');
            link.classList.add('bg-blue-600','text-white','shadow-md','shadow-blue-600/30');
          }
        }, 100);
        document.getElementById('sidebar-toggle')?.addEventListener('click', () => {
          document.getElementById('sidebar')?.classList.toggle('-translate-x-full');
        });
      })
      .catch(() => console.warn('sidebar.html not found — use a local server.'));

    // ── DOM REFS ────────────────────────────────────────────────
    const reportBody   = document.getElementById('reportBody');
    const emptyState   = document.getElementById('empty-state');
    const recordCount  = document.getElementById('record-count');
    const searchInput  = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    const printBtn     = document.getElementById('print-btn');
    const exportBtn    = document.getElementById('export-btn');
    const overlay      = document.getElementById('confirm-overlay');
    const modal        = document.getElementById('confirm-modal');
    const signoutBtn   = document.getElementById('signout-btn');
    const noBtn        = document.getElementById('noBtn');
    const toast        = document.getElementById('toast');
    const toastMsg     = document.getElementById('toast-msg');

    document.getElementById('print-date').textContent = new Date().toLocaleDateString('en-KE', {
      day: '2-digit', month: 'long', year: 'numeric'
    });

    // ── MODAL ───────────────────────────────────────────────────
    function openModal() {
      overlay.classList.remove('hidden');
      requestAnimationFrame(() => {
        modal.classList.remove('scale-95','opacity-0');
        modal.classList.add('scale-100','opacity-100');
      });
    }
    function closeModal() {
      modal.classList.add('scale-95','opacity-0');
      modal.classList.remove('scale-100','opacity-100');
      setTimeout(() => overlay.classList.add('hidden'), 200);
    }
    signoutBtn.addEventListener('click', openModal);
    noBtn.addEventListener('click', closeModal);
    overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });

    // ── TOAST ───────────────────────────────────────────────────
    function showToast(msg) {
      toastMsg.textContent = msg;
      toast.classList.remove('translate-y-16','opacity-0');
      toast.classList.add('translate-y-0','opacity-100');
      setTimeout(() => {
        toast.classList.add('translate-y-16','opacity-0');
        toast.classList.remove('translate-y-0','opacity-100');
      }, 3000);
    }

    // ── SERVICE STATUS LOGIC ─────────────────────────────────────
    // Returns 'ok', 'due' (within 14 days), or 'overdue'
    function getServiceStatus(nextServiceStr) {
      if (!nextServiceStr) return 'ok';
      const next = new Date(nextServiceStr);
      if (isNaN(next)) return 'ok';
      const today = new Date();
      today.setHours(0,0,0,0);
      const diffDays = Math.ceil((next - today) / (1000 * 60 * 60 * 24));
      if (diffDays < 0)  return 'overdue';
      if (diffDays <= 14) return 'due';
      return 'ok';
    }

    function statusPill(status) {
      const cfg = {
        ok:      { label: 'Up to Date', cls: 'bg-emerald-50 text-emerald-600 border-emerald-200', dot: 'bg-emerald-500' },
        due:     { label: 'Due Soon',   cls: 'bg-amber-50 text-amber-600 border-amber-200',       dot: 'bg-amber-400'  },
        overdue: { label: 'Overdue',    cls: 'bg-red-50 text-red-600 border-red-200',             dot: 'bg-red-500'    },
      };
      const c = cfg[status] || cfg.ok;
      return `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-xs font-semibold border ${c.cls}">
        <span class="w-1.5 h-1.5 rounded-full ${c.dot}"></span>${c.label}
      </span>`;
    }

    // ── FORMAT DATE ──────────────────────────────────────────────
    function fmtDate(d) {
      if (!d) return 'N/A';
      const dt = new Date(d);
      if (isNaN(dt)) return d; // return as-is if not a valid date
      return dt.toLocaleDateString('en-KE', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    // ── RENDER TABLE ─────────────────────────────────────────────
    let allServices = [];

    function renderTable(data) {
      reportBody.innerHTML = '';
      if (!data || data.length === 0) {
        emptyState.style.display = 'flex';
        recordCount.textContent = '0';
        return;
      }
      emptyState.style.display = 'none';
      recordCount.textContent = data.length;

      data.forEach((service, i) => {
        const status = getServiceStatus(service.nextService);
        const row = document.createElement('tr');
        row.className = 'row-in hover:bg-slate-50 transition-colors';
        row.dataset.status = status;
        row.dataset.text   = `${service.plates||''} ${service.rider||''}`.toLowerCase();

        // Plate badge color based on status
        const plateCls = {
          ok:      'bg-slate-100 text-slate-700',
          due:     'bg-amber-50 text-amber-700',
          overdue: 'bg-red-50 text-red-700',
        }[status];

        // Rider initials
        const name = service.rider || 'N/A';
        const initials = name !== 'N/A'
          ? name.split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase()
          : '?';
        const avatarColors = [
          'bg-violet-100 text-violet-600',
          'bg-blue-100 text-blue-600',
          'bg-emerald-100 text-emerald-600',
          'bg-orange-100 text-orange-600',
          'bg-pink-100 text-pink-600',
        ];
        const avatarCls = avatarColors[i % avatarColors.length];

        row.innerHTML = `
          <td class="px-6 py-4 text-slate-400 text-xs font-mono">${String(i + 1).padStart(2, '0')}</td>
          <td class="px-6 py-4">
            <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl ${plateCls} text-sm font-bold tracking-widest">
              <svg class="w-3.5 h-3.5 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <rect x="2" y="7" width="20" height="10" rx="2" ry="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 12h10"/>
              </svg>
              ${service.plates || 'N/A'}
            </span>
          </td>
          <td class="px-6 py-4">
            <div class="flex items-center gap-2.5">
              <div class="w-7 h-7 rounded-full ${avatarCls} flex items-center justify-center text-xs font-bold flex-shrink-0">${initials}</div>
              <span class="font-semibold text-slate-700">${name}</span>
            </div>
          </td>
          <td class="px-6 py-4 text-slate-500">${fmtDate(service.service)}</td>
          <td class="px-6 py-4 font-medium ${status === 'overdue' ? 'text-red-600' : status === 'due' ? 'text-amber-600' : 'text-slate-700'}">
            ${fmtDate(service.nextService)}
          </td>
          <td class="px-6 py-4 no-print">${statusPill(status)}</td>
        `;
        reportBody.appendChild(row);
      });
    }

    // ── STATS ────────────────────────────────────────────────────
    function updateStats(data) {
      const total   = data.length;
      const overdue = data.filter(s => getServiceStatus(s.nextService) === 'overdue').length;
      const due     = data.filter(s => getServiceStatus(s.nextService) === 'due').length;
      const ok      = total - overdue - due;
      document.getElementById('stat-total').textContent   = total;
      document.getElementById('stat-overdue').textContent = overdue;
      document.getElementById('stat-due').textContent     = due;
      document.getElementById('stat-ok').textContent      = ok;
    }

    // ── FILTERS ──────────────────────────────────────────────────
    function applyFilters() {
      const q  = (searchInput?.value || '').toLowerCase();
      const sf = statusFilter?.value || 'all';
      const filtered = allServices.filter(s => {
        const matchText   = `${s.plates||''} ${s.rider||''}`.toLowerCase().includes(q);
        const matchStatus = sf === 'all' || getServiceStatus(s.nextService) === sf;
        return matchText && matchStatus;
      });
      renderTable(filtered);
    }

    searchInput?.addEventListener('input', applyFilters);
    statusFilter?.addEventListener('change', applyFilters);

    // ── PRINT ────────────────────────────────────────────────────
    printBtn?.addEventListener('click', () => window.print());

    // ── EXPORT CSV ───────────────────────────────────────────────
    exportBtn?.addEventListener('click', () => {
      if (!allServices.length) { showToast('No data to export.'); return; }
      const headers = ['Bike Plates','Rider','Previous Service','Next Service','Status'];
      const rows = allServices.map(s => [
        s.plates || 'N/A',
        s.rider  || 'N/A',
        fmtDate(s.service),
        fmtDate(s.nextService),
        { ok: 'Up to Date', due: 'Due Soon', overdue: 'Overdue' }[getServiceStatus(s.nextService)]
      ]);
      const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = `fleetpulse-service-report-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('CSV exported successfully!');
    });

    // ── LOAD DATA ────────────────────────────────────────────────
    window.addEventListener('DOMContentLoaded', () => {
      allServices = JSON.parse(localStorage.getItem('services')) || [];
      updateStats(allServices);
      renderTable(allServices);
    });
  </script>
</body>
</html>