<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <title>Dashboard — FleetPulse</title>
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; }
    #sidebar-mount { display: contents; }
    .fade-up {
      opacity: 0;
      transform: translateY(16px);
      animation: fadeUp 0.5s ease forwards;
    }
    @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
    select { background-image: none; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 99px; }
    #confirm-overlay { backdrop-filter: blur(4px); }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <!-- SIDEBAR -->
  <div id="sidebar-mount"></div>

  <!-- TOP NAV -->
  <header class="fixed top-0 right-0 left-0 sm:left-64 z-30 h-16 bg-white border-b border-slate-100 flex items-center justify-between px-6 shadow-sm">
    <button id="sidebar-toggle" class="sm:hidden p-2 rounded-lg hover:bg-slate-100 text-slate-500 transition-colors">
      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </button>
    <div class="flex items-center gap-2 text-sm">
      <span class="text-slate-400">FleetPulse</span>
      <span class="text-slate-300">/</span>
      <span class="font-semibold text-slate-700">Dashboard</span>
    </div>
    <div class="flex items-center gap-3">
      <!-- Live clock -->
      <div class="hidden sm:flex items-center gap-2 text-xs text-slate-400 bg-slate-50 border border-slate-200 px-3 py-1.5 rounded-lg">
        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span id="clock" class="font-mono font-medium text-slate-600"></span>
      </div>
      <button class="relative p-2 rounded-lg hover:bg-slate-100 text-slate-400 transition-colors">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
        </svg>
        <span class="absolute top-1.5 right-1.5 w-2 h-2 bg-blue-500 rounded-full"></span>
      </button>
      <button id="signout-btn"
        class="flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-red-500 bg-slate-100 hover:bg-red-50 px-4 py-2 rounded-lg transition-all">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
        </svg>
        Sign out
      </button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="sm:ml-64 pt-16 min-h-screen">
    <div class="p-6 md:p-8 max-w-6xl mx-auto">

      <!-- Welcome banner -->
      <div class="mb-8 fade-up" style="animation-delay:.04s">
        <div class="bg-blue-600 rounded-2xl px-7 py-6 flex items-center justify-between gap-4 shadow-lg shadow-blue-500/20 overflow-hidden relative">
          <!-- decorative circles -->
          <div class="absolute -right-8 -top-8 w-40 h-40 bg-white/10 rounded-full pointer-events-none"></div>
          <div class="absolute right-16 bottom-[-20px] w-24 h-24 bg-white/5 rounded-full pointer-events-none"></div>
          <div class="relative z-10">
            <p class="text-blue-100 text-sm font-medium mb-1" id="date-label"></p>
            <h1 class="text-white text-2xl font-bold">Welcome back, Fleet Manager</h1>
            <p class="text-blue-200 text-sm mt-1">Here's what's happening across your fleet today.</p>
          </div>
          <div class="relative z-10 hidden sm:flex items-center justify-center w-14 h-14 bg-white/15 rounded-2xl flex-shrink-0">
            <svg class="w-7 h-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
          </div>
        </div>
      </div>

      <!-- KPI CARDS ROW 1 -->
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4 fade-up" style="animation-delay:.08s">

        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm px-5 py-4 flex flex-col gap-3">
          <div class="flex items-center justify-between">
            <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide">Total Riders</p>
            <div class="w-8 h-8 rounded-xl bg-blue-50 flex items-center justify-center">
              <svg class="w-4 h-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </div>
          </div>
          <p class="text-3xl font-bold text-slate-800" id="kpi-riders">0</p>
          <p class="text-xs text-slate-400" id="kpi-riders-sub">across 0 branches</p>
        </div>

        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm px-5 py-4 flex flex-col gap-3">
          <div class="flex items-center justify-between">
            <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide">Deliveries</p>
            <div class="w-8 h-8 rounded-xl bg-indigo-50 flex items-center justify-center">
              <svg class="w-4 h-4 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
            </div>
          </div>
          <p class="text-3xl font-bold text-slate-800" id="kpi-deliveries">0</p>
          <p class="text-xs text-slate-400" id="kpi-deliveries-sub">0 in transit</p>
        </div>

        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm px-5 py-4 flex flex-col gap-3">
          <div class="flex items-center justify-between">
            <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide">Total Expenses</p>
            <div class="w-8 h-8 rounded-xl bg-red-50 flex items-center justify-center">
              <svg class="w-4 h-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
          </div>
          <p class="text-3xl font-bold text-slate-800" id="kpi-expenses">0</p>
          <p class="text-xs text-slate-400">KES total spend</p>
        </div>

        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm px-5 py-4 flex flex-col gap-3">
          <div class="flex items-center justify-between">
            <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide">Maintenance</p>
            <div class="w-8 h-8 rounded-xl bg-orange-50 flex items-center justify-center">
              <svg class="w-4 h-4 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </div>
          </div>
          <p class="text-3xl font-bold text-slate-800" id="kpi-bikes">0</p>
          <p class="text-xs text-slate-400" id="kpi-bikes-sub">0 overdue</p>
        </div>
      </div>

      <!-- ALERTS ROW -->
      <div id="alerts-row" class="mb-6 space-y-2 fade-up" style="animation-delay:.1s"></div>

      <!-- CHARTS + PANELS ROW -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4 fade-up" style="animation-delay:.13s">

        <!-- Bar chart: riders per branch (spans 2 cols) -->
        <div class="lg:col-span-2 bg-white rounded-2xl border border-slate-100 shadow-sm p-6">
          <div class="flex items-center justify-between mb-5">
            <div>
              <h3 class="font-bold text-slate-800">Rider Distribution</h3>
              <p class="text-xs text-slate-400 mt-0.5">Riders per branch</p>
            </div>
            <span class="text-xs font-semibold text-blue-600 bg-blue-50 border border-blue-100 px-2.5 py-1 rounded-full" id="chart-total-label">0 total</span>
          </div>
          <div class="h-56">
            <canvas id="riderChart"></canvas>
          </div>
        </div>

        <!-- Expense breakdown doughnut -->
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-6">
          <div class="mb-5">
            <h3 class="font-bold text-slate-800">Expense Breakdown</h3>
            <p class="text-xs text-slate-400 mt-0.5">By type</p>
          </div>
          <div class="h-40 flex items-center justify-center">
            <canvas id="expenseChart"></canvas>
          </div>
          <div id="expense-legend" class="mt-4 space-y-2"></div>
        </div>
      </div>

      <!-- BOTTOM ROW: Recent deliveries + Maintenance alerts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 fade-up" style="animation-delay:.16s">

        <!-- Recent deliveries -->
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm">
          <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
            <h3 class="font-bold text-slate-800">Recent Deliveries</h3>
            <a href="assign.html" class="text-xs font-semibold text-blue-600 hover:text-blue-700 transition-colors">View all →</a>
          </div>
          <div id="recent-deliveries" class="divide-y divide-slate-50"></div>
          <div id="no-deliveries" class="hidden py-10 text-center text-sm text-slate-300">
            <svg class="w-8 h-8 mx-auto mb-2 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
            No deliveries assigned yet
          </div>
        </div>

        <!-- Maintenance status list -->
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm">
          <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
            <h3 class="font-bold text-slate-800">Maintenance Status</h3>
            <a href="maintainance.html" class="text-xs font-semibold text-blue-600 hover:text-blue-700 transition-colors">Manage →</a>
          </div>
          <div id="maintenance-list" class="divide-y divide-slate-50"></div>
          <div id="no-maintenance" class="hidden py-10 text-center text-sm text-slate-300">
            <svg class="w-8 h-8 mx-auto mb-2 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/></svg>
            No bikes logged yet
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- SIGN-OUT MODAL -->
  <div id="confirm-overlay" class="hidden fixed inset-0 z-50 bg-slate-900/40 flex items-center justify-center">
    <div id="confirm-modal" class="bg-white rounded-2xl shadow-2xl p-7 w-80 text-center transform transition-all scale-95 opacity-0">
      <div class="w-12 h-12 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-6 h-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
        </svg>
      </div>
      <h3 class="font-bold text-slate-800 mb-1">Sign out?</h3>
      <p class="text-sm text-slate-400 mb-6">You'll be redirected to the login page.</p>
      <div class="flex gap-3">
        <button id="noBtn" class="flex-1 py-2.5 rounded-xl border border-slate-200 text-slate-600 text-sm font-medium hover:bg-slate-50 transition-colors">Cancel</button>
        <a href="login.html" class="flex-1 py-2.5 rounded-xl bg-red-500 text-white text-sm font-semibold hover:bg-red-600 transition-colors text-center">Sign out</a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ── SIDEBAR IMPORT ──────────────────────────────────────────
    fetch('sidebar.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('sidebar-mount').innerHTML = html;
        setTimeout(() => {
          document.querySelectorAll('.sidebar-link').forEach(a => {
            a.classList.remove('bg-blue-600','text-white','shadow-md','shadow-blue-600/30','font-semibold');
            a.classList.add('text-slate-300');
          });
          const link = document.querySelector('a[href="dashboard.html"]');
          if (link) {
            link.classList.remove('text-slate-300');
            link.classList.add('bg-blue-600','text-white','shadow-md','shadow-blue-600/30');
          }
        }, 100);
        document.getElementById('sidebar-toggle')?.addEventListener('click', () => {
          document.getElementById('sidebar')?.classList.toggle('-translate-x-full');
        });
      })
      .catch(() => console.warn('sidebar.html not found — use a local server.'));

    // ── CLOCK ───────────────────────────────────────────────────
    const clockEl = document.getElementById('clock');
    function tick() {
      const now = new Date();
      const p = n => String(n).padStart(2,'0');
      clockEl.textContent = `${p(now.getHours())}:${p(now.getMinutes())}:${p(now.getSeconds())}`;
    }
    tick(); setInterval(tick, 1000);

    // ── DATE LABEL ───────────────────────────────────────────────
    document.getElementById('date-label').textContent = new Date().toLocaleDateString('en-KE', {
      weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
    });

    // ── MODAL ───────────────────────────────────────────────────
    const overlay    = document.getElementById('confirm-overlay');
    const modal      = document.getElementById('confirm-modal');
    const signoutBtn = document.getElementById('signout-btn');
    const noBtn      = document.getElementById('noBtn');

    signoutBtn.addEventListener('click', () => {
      overlay.classList.remove('hidden');
      requestAnimationFrame(() => {
        modal.classList.remove('scale-95','opacity-0');
        modal.classList.add('scale-100','opacity-100');
      });
    });
    noBtn.addEventListener('click', () => {
      modal.classList.add('scale-95','opacity-0');
      modal.classList.remove('scale-100','opacity-100');
      setTimeout(() => overlay.classList.add('hidden'), 200);
    });
    overlay.addEventListener('click', e => {
      if (e.target === overlay) noBtn.click();
    });

    // ── HELPERS ──────────────────────────────────────────────────
    function fmt(n) {
      return 'KES ' + Number(n).toLocaleString('en-KE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    function fmtDate(d) {
      if (!d) return '—';
      const dt = new Date(d + 'T00:00:00');
      if (isNaN(dt)) return d;
      return dt.toLocaleDateString('en-KE', { day: '2-digit', month: 'short', year: 'numeric' });
    }
    function getServiceStatus(nextStr) {
      if (!nextStr) return 'ok';
      const next  = new Date(nextStr);
      if (isNaN(next)) return 'ok';
      const today = new Date(); today.setHours(0,0,0,0);
      const diff  = Math.ceil((next - today) / 86400000);
      if (diff < 0)   return 'overdue';
      if (diff <= 14) return 'due';
      return 'ok';
    }

    // ── LOAD DATA ────────────────────────────────────────────────
    window.addEventListener('DOMContentLoaded', () => {
      const riders    = JSON.parse(localStorage.getItem('riders'))    || [];
      const entries   = JSON.parse(localStorage.getItem('entries'))   || [];
      const expenses  = JSON.parse(localStorage.getItem('expenses'))  || [];
      const services  = JSON.parse(localStorage.getItem('services'))  || [];

      // ── KPI CARDS ─────────────────────────────────────────────
      const branches = [...new Set(riders.map(r => r.category))];
      document.getElementById('kpi-riders').textContent     = riders.length;
      document.getElementById('kpi-riders-sub').textContent = `across ${branches.length} branch${branches.length !== 1 ? 'es' : ''}`;

      const inTransit = entries.filter(e => e.status === 'In Transit').length;
      document.getElementById('kpi-deliveries').textContent     = entries.length;
      document.getElementById('kpi-deliveries-sub').textContent = `${inTransit} in transit`;

      const totalExpense = expenses.reduce((s, e) => s + Number(e.amount), 0);
      document.getElementById('kpi-expenses').textContent = fmt(totalExpense);

      const overdueCount = services.filter(s => getServiceStatus(s.nextService) === 'overdue').length;
      const dueCount     = services.filter(s => getServiceStatus(s.nextService) === 'due').length;
      document.getElementById('kpi-bikes').textContent     = services.length;
      document.getElementById('kpi-bikes-sub').textContent = `${overdueCount} overdue, ${dueCount} due soon`;

      // ── ALERTS ────────────────────────────────────────────────
      const alertsRow = document.getElementById('alerts-row');
      if (overdueCount > 0) {
        alertsRow.innerHTML += `
          <div class="flex items-center gap-3 bg-red-50 border border-red-200 rounded-xl px-4 py-3 text-sm">
            <svg class="w-4 h-4 text-red-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
            <span class="text-red-700 font-medium">${overdueCount} bike${overdueCount > 1 ? 's are' : ' is'} overdue for service.</span>
            <a href="maintainance.html" class="ml-auto text-xs font-bold text-red-600 hover:text-red-800 underline">Fix now →</a>
          </div>`;
      }
      if (dueCount > 0) {
        alertsRow.innerHTML += `
          <div class="flex items-center gap-3 bg-amber-50 border border-amber-200 rounded-xl px-4 py-3 text-sm">
            <svg class="w-4 h-4 text-amber-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
            <span class="text-amber-700 font-medium">${dueCount} bike${dueCount > 1 ? 's are' : ' is'} due for service within 14 days.</span>
            <a href="maintainance.html" class="ml-auto text-xs font-bold text-amber-600 hover:text-amber-800 underline">Review →</a>
          </div>`;
      }

      // ── BAR CHART: Riders per branch ──────────────────────────
      const categoryCounts = {};
      riders.forEach(r => {
        categoryCounts[r.category] = (categoryCounts[r.category] || 0) + 1;
      });
      const labels = Object.keys(categoryCounts);
      const data   = Object.values(categoryCounts);

      document.getElementById('chart-total-label').textContent = `${riders.length} total`;

      const barColors = [
        'rgba(37,99,235,0.85)',
        'rgba(99,102,241,0.85)',
        'rgba(14,165,233,0.85)',
        'rgba(6,182,212,0.85)',
        'rgba(59,130,246,0.85)',
        'rgba(139,92,246,0.85)',
      ];

      const barCtx = document.getElementById('riderChart').getContext('2d');
      new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: labels.length ? labels : ['No data'],
          datasets: [{
            label: 'Riders',
            data: data.length ? data : [0],
            backgroundColor: barColors,
            borderRadius: 8,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => ` ${ctx.parsed.y} rider${ctx.parsed.y !== 1 ? 's' : ''}`
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { font: { family: 'Plus Jakarta Sans', size: 12 }, color: '#94a3b8' }
            },
            y: {
              grid: { color: '#f1f5f9' },
              ticks: {
                stepSize: 1,
                font: { family: 'Plus Jakarta Sans', size: 12 },
                color: '#94a3b8'
              },
              beginAtZero: true
            }
          }
        }
      });

      // ── DOUGHNUT CHART: Expenses by type ─────────────────────
      const expenseTypes = ['Fuel','Service','Car wash','Repair','Other'];
      const expenseColors = ['#2563eb','#1e293b','#0ea5e9','#6366f1','#94a3b8'];
      const expenseTotals = expenseTypes.map(t =>
        expenses.filter(e => e.expenseType === t).reduce((s,e) => s + Number(e.amount), 0)
      );
      const hasExpenses = expenseTotals.some(v => v > 0);

      const donutCtx = document.getElementById('expenseChart').getContext('2d');
      new Chart(donutCtx, {
        type: 'doughnut',
        data: {
          labels: expenseTypes,
          datasets: [{
            data: hasExpenses ? expenseTotals : [1],
            backgroundColor: hasExpenses ? expenseColors : ['#e2e8f0'],
            borderWidth: 0,
            hoverOffset: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: hasExpenses,
              callbacks: {
                label: ctx => ` ${fmt(ctx.parsed)}`
              }
            }
          }
        }
      });

      // Expense legend
      const legendEl = document.getElementById('expense-legend');
      if (hasExpenses) {
        expenseTypes.forEach((t, i) => {
          if (expenseTotals[i] === 0) return;
          legendEl.innerHTML += `
            <div class="flex items-center justify-between text-xs">
              <div class="flex items-center gap-2">
                <span class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background:${expenseColors[i]}"></span>
                <span class="text-slate-600">${t}</span>
              </div>
              <span class="font-semibold text-slate-700">${fmt(expenseTotals[i])}</span>
            </div>`;
        });
      } else {
        legendEl.innerHTML = '<p class="text-xs text-slate-300 text-center">No expenses logged yet</p>';
      }

      // ── RECENT DELIVERIES ─────────────────────────────────────
      const deliveriesEl = document.getElementById('recent-deliveries');
      const noDeliveries = document.getElementById('no-deliveries');
      const recent = [...entries].reverse().slice(0, 5);

      if (recent.length === 0) {
        noDeliveries.classList.remove('hidden');
      } else {
        const statusCfg = {
          'Pending':    { cls: 'bg-amber-50 text-amber-600 border-amber-200',   dot: 'bg-amber-400'   },
          'In Transit': { cls: 'bg-blue-50 text-blue-600 border-blue-200',      dot: 'bg-blue-500'    },
          'Delivered':  { cls: 'bg-emerald-50 text-emerald-600 border-emerald-200', dot: 'bg-emerald-500' },
        };
        recent.forEach(e => {
          const sc   = statusCfg[e.status] || statusCfg['Pending'];
          const init = (e.rider||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
          deliveriesEl.innerHTML += `
            <div class="flex items-center gap-3 px-5 py-3 hover:bg-slate-50 transition-colors">
              <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center text-xs font-bold flex-shrink-0">${init}</div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-semibold text-slate-700 truncate">${e.rider || '—'}</p>
                <p class="text-xs text-slate-400 truncate">→ ${e.to || '—'} · ${e.from || '—'}</p>
              </div>
              <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-semibold border ${sc.cls} whitespace-nowrap">
                <span class="w-1.5 h-1.5 rounded-full ${sc.dot}"></span>${e.status || 'Pending'}
              </span>
            </div>`;
        });
      }

      // ── MAINTENANCE LIST ──────────────────────────────────────
      const maintEl   = document.getElementById('maintenance-list');
      const noMaint   = document.getElementById('no-maintenance');

      if (services.length === 0) {
        noMaint.classList.remove('hidden');
      } else {
        // Sort: overdue first, then due, then ok
        const sorted = [...services].sort((a, b) => {
          const order = { overdue: 0, due: 1, ok: 2 };
          return order[getServiceStatus(a.nextService)] - order[getServiceStatus(b.nextService)];
        }).slice(0, 5);

        const maintCfg = {
          ok:      { cls: 'bg-emerald-50 text-emerald-600 border-emerald-200', dot: 'bg-emerald-500', label: 'OK'       },
          due:     { cls: 'bg-amber-50 text-amber-600 border-amber-200',       dot: 'bg-amber-400',   label: 'Due Soon' },
          overdue: { cls: 'bg-red-50 text-red-600 border-red-200',             dot: 'bg-red-500',     label: 'Overdue'  },
        };

        sorted.forEach(s => {
          const status = getServiceStatus(s.nextService);
          const mc     = maintCfg[status];
          const init   = (s.rider||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
          maintEl.innerHTML += `
            <div class="flex items-center gap-3 px-5 py-3 hover:bg-slate-50 transition-colors">
              <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-700 flex items-center justify-center text-xs font-bold flex-shrink-0">${init}</div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-semibold text-slate-700 font-mono tracking-wider">${s.plates || '—'}</p>
                <p class="text-xs text-slate-400">Next: ${fmtDate(s.nextService)}</p>
              </div>
              <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-semibold border ${mc.cls} whitespace-nowrap">
                <span class="w-1.5 h-1.5 rounded-full ${mc.dot}"></span>${mc.label}
              </span>
            </div>`;
        });
      }
    });
  </script>
</body>
</html>
